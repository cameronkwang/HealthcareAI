import { BCBSCalculator } from './BCBSCalculator';
import { BCBSInput, BCBSParameters, BCBSPlanData } from '../../../types/bcbs';
import { IMonthlyClaimsData, LargeClaimant } from '../../../types/common';

describe('BCBSRenewalCalculator', () => {
  // Test data setup
  const createTestClaimsData = (months: number = 12): IMonthlyClaimsData[] => {
    const data: IMonthlyClaimsData[] = [];
    const baseDate = new Date('2023-12-01');
    
    for (let i = 0; i < months; i++) {
      const month = new Date(baseDate);
      month.setMonth(baseDate.getMonth() - i);
      
      data.push({
        month: month.toISOString().split('T')[0],
        memberMonths: {
          total: 1200 + (i * 20),
          medical: 1200 + (i * 20),
          rx: 1200 + (i * 20)
        },
        incurredClaims: {
          medical: 450000 + (i * 8000), // Varying medical claims
          rx: 95000 + (i * 3000),       // Varying Rx claims
          total: 545000 + (i * 11000)
        }
      });
    }
    
    return data.reverse(); // Oldest first
  };

  const createTestLargeClaimants = (): LargeClaimant[] => {
    return [
      {
        claimantId: 'LC001',
        incurredDate: new Date('2023-06-15'),
        totalAmount: 250000,
        medicalAmount: 250000,
        rxAmount: 0,
        diagnosis: 'Heart Surgery'
      },
      {
        claimantId: 'LC002', 
        incurredDate: new Date('2023-09-20'),
        totalAmount: 300000,
        medicalAmount: 280000,
        rxAmount: 20000,
        diagnosis: 'Cancer Treatment'
      },
      {
        claimantId: 'LC003',
        incurredDate: new Date('2023-11-10'),
        totalAmount: 275000,
        medicalAmount: 275000,
        rxAmount: 0,
        diagnosis: 'Emergency Surgery'
      }
    ];
  };

  const createTestPlans = (): BCBSPlanData[] => {
    return [
      {
        planId: 'SILVER3000',
        planName: 'Silver 3000',
        periods: {
          current: {
            medicalClaims: 1800000,
            pharmacyClaims: 380000,
            memberMonths: 4800
          }
        },
        largeClaimants: [
          {
            claimantId: 'LC001',
            incurredDate: new Date('2023-06-15'),
            totalAmount: 250000,
            claimType: 'medical'
          }
        ],
        enrollment: {
          single: 150,
          couple: 80,
          spmd: 40,
          family: 120,
          total: 390
        }
      },
      {
        planId: 'GOLD1000',
        planName: 'Gold 1000',
        periods: {
          current: {
            medicalClaims: 2100000,
            pharmacyClaims: 420000,
            memberMonths: 3600
          }
        },
        largeClaimants: [
          {
            claimantId: 'LC002',
            incurredDate: new Date('2023-09-20'),
            totalAmount: 300000,
            claimType: 'medical'
          }
        ],
        enrollment: {
          single: 100,
          couple: 120,
          spmd: 30,
          family: 150,
          total: 400
        }
      },
      {
        planId: 'PLATINUM500',
        planName: 'Platinum 500',
        periods: {
          current: {
            medicalClaims: 950000,
            pharmacyClaims: 210000,
            memberMonths: 2400
          }
        },
        largeClaimants: [
          {
            claimantId: 'LC003',
            incurredDate: new Date('2023-11-10'),
            totalAmount: 275000,
            claimType: 'medical'
          }
        ],
        enrollment: {
          single: 80,
          couple: 60,
          spmd: 20,
          family: 80,
          total: 240
        }
      }
    ];
  };

  const createTestParameters = (): BCBSParameters => {
    return {
      analysisDate: new Date('2023-12-31'),
      renewalEffectiveDate: new Date('2024-01-01'),
      planParameters: {
        'SILVER3000': {
          planId: 'SILVER3000',
          planName: 'Silver 3000',
          poolingLevel: 225000,
          poolingChargesPMPM: 18.00,
          medicalTrend: {
            base: 1.0500,
            compounded: 1.3235,
            months: 24
          },
          pharmacyTrend: {
            base: 1.0700,
            compounded: 1.3462,
            months: 24
          },
          medicalIBNR: 1.0200,
          pharmacyIBNR: 1.0050,
          ffsAgeAdjustment: 1.0300,
          experienceWeight: 0.85,
          manualRate: 480.00,
          retentionPMPM: 38.00,
          currentRate: 520.00
        },
        'GOLD1000': {
          planId: 'GOLD1000',
          planName: 'Gold 1000',
          poolingLevel: 200000,
          poolingChargesPMPM: 22.00,
          medicalTrend: {
            base: 1.0500,
            compounded: 1.3235,
            months: 24
          },
          pharmacyTrend: {
            base: 1.0700,
            compounded: 1.3462,
            months: 24
          },
          medicalIBNR: 1.0200,
          pharmacyIBNR: 1.0050,
          ffsAgeAdjustment: 1.0250,
          experienceWeight: 0.80,
          manualRate: 650.00,
          retentionPMPM: 45.00,
          currentRate: 720.00
        },
        'PLATINUM500': {
          planId: 'PLATINUM500',
          planName: 'Platinum 500',
          poolingLevel: 175000,
          poolingChargesPMPM: 25.00,
          medicalTrend: {
            base: 1.0500,
            compounded: 1.3235,
            months: 24
          },
          pharmacyTrend: {
            base: 1.0700,
            compounded: 1.3462,
            months: 24
          },
          medicalIBNR: 1.0200,
          pharmacyIBNR: 1.0050,
          ffsAgeAdjustment: 1.0200,
          experienceWeight: 0.75,
          manualRate: 850.00,
          retentionPMPM: 55.00,
          currentRate: 950.00
        }
      },
      compositeSettings: {
        weightingMethod: 'enrollment',
        minimumRateChange: -0.10,
        maximumRateChange: 0.25
      }
    };
  };

  const createTestInput = (
    customPlans?: BCBSPlanData[],
    customParams?: Partial<BCBSParameters>
  ): BCBSInput => {
    return {
      carrier: 'BCBS',
      caseId: 'BCBS-TEST-001',
      monthlyClaimsData: createTestClaimsData(),
      largeClaimantsData: createTestLargeClaimants(),
      effectiveDates: {
        renewalStart: new Date('2024-01-01'),
        renewalEnd: new Date('2024-12-31')
      },
      manualRates: {
        medical: 500.00,
        rx: 130.00,
        total: 630.00
      },
      carrierSpecificParameters: {
        ...createTestParameters(),
        ...customParams
      },
      plans: customPlans || createTestPlans()
    };
  };

  describe('Multi-Plan Calculation Flow', () => {
    test('should calculate all plans successfully', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      // Verify basic structure
      expect(result.carrier).toBe('BCBS');
      expect(result.plans).toHaveLength(3);
      expect(result.composite).toBeDefined();
      expect(result.summary.totalPlans).toBe(3);

      // Verify all plans are calculated
      const planIds = result.plans.map(p => p.planId);
      expect(planIds).toContain('SILVER3000');
      expect(planIds).toContain('GOLD1000');
      expect(planIds).toContain('PLATINUM500');

      // Each plan should have complete calculations
      result.plans.forEach(plan => {
        expect(plan.medical).toBeDefined();
        expect(plan.pharmacy).toBeDefined();
        expect(plan.total).toBeDefined();
        expect(plan.enrollment).toBeDefined();
        expect(plan.rateAction).toBeDefined();
      });
    });

    test('should handle single plan correctly', () => {
      const singlePlan = createTestPlans().slice(0, 1);
      const input = createTestInput(singlePlan);
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      expect(result.plans).toHaveLength(1);
      expect(result.summary.totalPlans).toBe(1);
      expect(result.plans[0].enrollment.weight).toBe(1.0); // 100% weight for single plan
    });
  });

  describe('Plan-Specific Calculations', () => {
    test('should calculate medical components correctly for each plan', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      const silverPlan = result.plans.find(p => p.planId === 'SILVER3000');
      expect(silverPlan).toBeDefined();

      // Verify medical calculations
      expect(silverPlan!.medical.incurredClaims).toBe(1800000);
      expect(silverPlan!.medical.netPMPM).toBeGreaterThan(0);
      expect(silverPlan!.medical.projectedPMPM).toBeGreaterThan(silverPlan!.medical.netPMPM);

      // Pooling should remove amounts over $225K threshold
      expect(silverPlan!.medical.pooledClaims).toBeGreaterThan(0);
      expect(silverPlan!.medical.netClaims).toBeLessThan(silverPlan!.medical.incurredClaims);
    });

    test('should calculate pharmacy components correctly', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      const goldPlan = result.plans.find(p => p.planId === 'GOLD1000');
      expect(goldPlan).toBeDefined();

      // Verify pharmacy calculations
      expect(goldPlan!.pharmacy.incurredClaims).toBe(420000);
      expect(goldPlan!.pharmacy.netPMPM).toBeGreaterThan(0);
      expect(goldPlan!.pharmacy.projectedPMPM).toBeGreaterThan(goldPlan!.pharmacy.netPMPM);

      // Pharmacy trend should be applied
      expect(goldPlan!.pharmacy.trendFactor).toBeCloseTo(1.3462, 3);
      expect(goldPlan!.pharmacy.ibnrFactor).toBeCloseTo(1.0050, 3);
    });

    test('should apply plan-specific pooling levels', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      const silverPlan = result.plans.find(p => p.planId === 'SILVER3000');
      const goldPlan = result.plans.find(p => p.planId === 'GOLD1000');
      const platinumPlan = result.plans.find(p => p.planId === 'PLATINUM500');

      // Different plans should have different pooling calculations
      // Silver: $225K threshold
      // Gold: $200K threshold
      // Platinum: $175K threshold
      
      // Since all large claimants are above all thresholds, 
      // but thresholds differ, pooled amounts should differ
      expect(silverPlan!.medical.pooledClaims).not.toBe(goldPlan!.medical.pooledClaims);
      expect(goldPlan!.medical.pooledClaims).not.toBe(platinumPlan!.medical.pooledClaims);
    });

    test('should calculate total components with proper adjustments', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      const platinumPlan = result.plans.find(p => p.planId === 'PLATINUM500');
      expect(platinumPlan).toBeDefined();

      // Verify total calculation flow
      const expectedCombined = platinumPlan!.medical.projectedPMPM + platinumPlan!.pharmacy.projectedPMPM;
      expect(platinumPlan!.total.combinedProjectedPMPM).toBeCloseTo(expectedCombined, 2);

      // Age adjustment should be applied
      expect(platinumPlan!.total.adjustedPMPM).toBeCloseTo(
        expectedCombined * 1.0200, 2 // Platinum FFS age adjustment
      );

      // Pooling charges should be added
      expect(platinumPlan!.total.withPoolingCharges).toBeCloseTo(
        platinumPlan!.total.adjustedPMPM + 25.00, 2 // Platinum pooling charges
      );

      // Experience/manual blending should occur
      expect(platinumPlan!.total.experienceWeight).toBe(0.75);
      expect(platinumPlan!.total.experienceComponent).toBeGreaterThan(0);
      expect(platinumPlan!.total.manualComponent).toBeGreaterThan(0);

      // Final premium includes retention
      expect(platinumPlan!.total.requiredPremium).toBeCloseTo(
        platinumPlan!.total.credibilityAdjustedPMPM + 55.00, 2 // Platinum retention
      );
    });
  });

  describe('Enrollment Weighting', () => {
    test('should calculate plan weights correctly', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      const totalEnrollment = 390 + 400 + 240; // Silver + Gold + Platinum
      
      const silverPlan = result.plans.find(p => p.planId === 'SILVER3000');
      const goldPlan = result.plans.find(p => p.planId === 'GOLD1000');
      const platinumPlan = result.plans.find(p => p.planId === 'PLATINUM500');

      expect(silverPlan!.enrollment.weight).toBeCloseTo(390 / totalEnrollment, 3);
      expect(goldPlan!.enrollment.weight).toBeCloseTo(400 / totalEnrollment, 3);
      expect(platinumPlan!.enrollment.weight).toBeCloseTo(240 / totalEnrollment, 3);

      // Weights should sum to 1.0
      const totalWeight = silverPlan!.enrollment.weight + goldPlan!.enrollment.weight + platinumPlan!.enrollment.weight;
      expect(totalWeight).toBeCloseTo(1.0, 3);
    });

    test('should calculate enrollment-weighted composite premium', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      // Verify composite calculation
      const expectedWeightedPremium = result.plans.reduce((sum, plan) => {
        return sum + (plan.total.requiredPremium * plan.enrollment.weight);
      }, 0);

      expect(result.composite.weightedPremiumPMPM).toBeCloseTo(expectedWeightedPremium, 2);
      expect(result.composite.totalEnrollment).toBe(1030); // 390 + 400 + 240
    });
  });

  describe('Rate Actions', () => {
    test('should calculate rate changes correctly for each plan', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      result.plans.forEach(plan => {
        const expectedRateChange = plan.total.requiredPremium - plan.rateAction.currentRate;
        const expectedChangePercent = expectedRateChange / plan.rateAction.currentRate;

        expect(plan.rateAction.rateChange).toBeCloseTo(expectedRateChange, 2);
        expect(plan.rateAction.changePercent).toBeCloseTo(expectedChangePercent, 4);
        expect(plan.rateAction.requiredRate).toBe(plan.total.requiredPremium);
      });
    });

    test('should classify rate action status correctly', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      result.plans.forEach(plan => {
        const changePercent = plan.rateAction.changePercent;
        
        if (Math.abs(changePercent) < 0.02) {
          expect(plan.rateAction.status).toBe('minimal');
        } else if (changePercent > 0) {
          expect(plan.rateAction.status).toBe('increase');
        } else {
          expect(plan.rateAction.status).toBe('decrease');
        }
      });
    });

    test('should calculate weighted average rate change', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      const expectedAverage = result.plans.reduce((sum, plan) => {
        return sum + (plan.rateAction.changePercent * plan.enrollment.weight);
      }, 0);

      expect(result.composite.averageRateChange).toBeCloseTo(expectedAverage, 4);
    });
  });

  describe('Composite Analysis', () => {
    test('should provide accurate composite metrics', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      // Verify composite totals
      const expectedMedicalClaims = result.plans.reduce((sum, plan) => sum + plan.medical.incurredClaims, 0);
      const expectedPharmacyClaims = result.plans.reduce((sum, plan) => sum + plan.pharmacy.incurredClaims, 0);

      expect(result.composite.totalMedicalClaims).toBe(expectedMedicalClaims);
      expect(result.composite.totalPharmacyClaims).toBe(expectedPharmacyClaims);

      // Plan weights should be properly stored
      expect(Object.keys(result.composite.planWeights)).toHaveLength(3);
      expect(result.composite.planWeights['SILVER3000']).toBeDefined();
      expect(result.composite.planWeights['GOLD1000']).toBeDefined();
      expect(result.composite.planWeights['PLATINUM500']).toBeDefined();
    });

    test('should calculate range of rate changes', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      const rateChanges = result.plans.map(plan => plan.rateAction.changePercent);
      const minChange = Math.min(...rateChanges);
      const maxChange = Math.max(...rateChanges);

      expect(result.summary.rangeOfRateChanges.minimum).toBe(minChange);
      expect(result.summary.rangeOfRateChanges.maximum).toBe(maxChange);
    });
  });

  describe('Error Handling', () => {
    test('should throw error for missing plan parameters', () => {
      const incompleteParams = createTestParameters();
      delete incompleteParams.planParameters['SILVER3000'];

      const input = createTestInput(undefined, incompleteParams);
      const calculator = new BCBSCalculator(input);

      expect(() => calculator.calculate()).toThrow('Parameters missing for plan SILVER3000');
    });

    test('should throw error for no plans', () => {
      const input = createTestInput([]);
      const calculator = new BCBSCalculator(input);

      expect(() => calculator.calculate()).toThrow('At least one plan is required');
    });

    test('should handle plans with zero enrollment gracefully', () => {
      const plansWithZeroEnrollment = createTestPlans();
      plansWithZeroEnrollment[0].enrollment = {
        single: 0,
        couple: 0,
        spmd: 0,
        family: 0,
        total: 0
      };

      const input = createTestInput(plansWithZeroEnrollment);
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      // Should still calculate but with zero weight
      expect(result.plans).toHaveLength(3);
      const zeroPlan = result.plans.find(p => p.planId === 'SILVER3000');
      expect(zeroPlan!.enrollment.weight).toBeCloseTo(0, 3);
    });
  });

  describe('Data Quality Assessment', () => {
    test('should assess data quality correctly', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      expect(result.dataQuality.dataCompleteness).toBeGreaterThan(0);
      expect(result.dataQuality.plansWithSufficientData).toBeGreaterThan(0);
      expect(result.dataQuality.annualizationApplied).toBe(false); // 12 months = no annualization
    });

    test('should identify plans with insufficient data', () => {
      const smallPlans = createTestPlans();
      smallPlans[0].enrollment.total = 5; // Below minimum threshold

      const input = createTestInput(smallPlans);
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      // Should flag plans with insufficient enrollment
      expect(result.dataQuality.plansWithSufficientData).toBeLessThan(3);
    });
  });

  describe('Trend Factor Application', () => {
    test('should apply correct trend factors by plan type', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      result.plans.forEach(plan => {
        // Medical trend should be 1.3235 for all plans (24-month compounded)
        expect(plan.medical.trendFactor).toBeCloseTo(1.3235, 3);
        
        // Pharmacy trend should be 1.3462 for all plans (24-month compounded)
        expect(plan.pharmacy.trendFactor).toBeCloseTo(1.3462, 3);
      });
    });
  });

  describe('IBNR Factor Application', () => {
    test('should apply IBNR factors correctly', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      result.plans.forEach(plan => {
        expect(plan.medical.ibnrFactor).toBeCloseTo(1.0200, 4);
        expect(plan.pharmacy.ibnrFactor).toBeCloseTo(1.0050, 4);
      });
    });
  });

  describe('Experience vs Manual Blending', () => {
    test('should blend experience and manual rates by plan-specific weights', () => {
      const input = createTestInput();
      const calculator = new BCBSCalculator(input);
      const result = calculator.calculate();

      const silverPlan = result.plans.find(p => p.planId === 'SILVER3000');
      const goldPlan = result.plans.find(p => p.planId === 'GOLD1000');
      const platinumPlan = result.plans.find(p => p.planId === 'PLATINUM500');

      // Different experience weights should be applied
      expect(silverPlan!.total.experienceWeight).toBe(0.85);
      expect(goldPlan!.total.experienceWeight).toBe(0.80);
      expect(platinumPlan!.total.experienceWeight).toBe(0.75);

      // Manual components should reflect the remaining weights
      result.plans.forEach(plan => {
        const experienceWeight = plan.total.experienceWeight;
        const expectedExperience = plan.total.withPoolingCharges * experienceWeight;
        const expectedManual = plan.rateAction.currentRate * (1 - experienceWeight); // Using current rate as proxy for manual rate
        
        expect(plan.total.experienceComponent).toBeCloseTo(expectedExperience, 2);
        // Note: Manual component calculation may vary based on plan parameters
      });
    });
  });
});

describe('Enhanced BCBS Multi-Plan Calculator', () => {
  let calculator: BCBSCalculator;

  beforeEach(() => {
    calculator = new BCBSCalculator();
  });

  const createTestInput = (): BCBSInput => {
    return {
      carrier: 'BCBS',
      caseId: 'BCBS-ENHANCED-TEST',
      effectiveDates: {
        renewalStart: new Date('2024-01-01'),
        renewalEnd: new Date('2024-12-31')
      },
      monthlyClaimsData: [
        {
          month: '2023-01',
          memberMonths: { medical: 1000, rx: 1000, total: 1000 },
          incurredClaims: { medical: 400000, rx: 100000, total: 500000 },
          planBreakdown: {
            'PPO High': { medical: 200000, rx: 50000, memberMonths: 470 },
            'PPO Standard': { medical: 120000, rx: 30000, memberMonths: 335 },
            'HDHP': { medical: 60000, rx: 15000, memberMonths: 250 },
            'EPO': { medical: 20000, rx: 5000, memberMonths: 160 }
          }
        }
      ],
      largeClaimantsData: [
        {
          claimantId: 'PPO-H-LC001',
          incurredDate: new Date('2023-06-15'),
          totalAmount: 225000,
          medicalAmount: 205000,
          rxAmount: 20000,
          planName: 'PPO High'
        },
        {
          claimantId: 'EPO-LC001',
          incurredDate: new Date('2023-08-10'),
          totalAmount: 185000,
          medicalAmount: 175000,
          rxAmount: 10000,
          planName: 'EPO'
        }
      ],
      manualRates: {
        medical: 450.00,
        rx: 125.00,
        total: 575.00
      },
      multiPlanData: {
        plans: [
          {
            planId: 'plan1',
            experiencePeriods: {
              current: {
                startDate: new Date('2023-02-01'),
                endDate: new Date('2024-01-31'),
                memberMonths: 5310
              },
              renewal: {
                startDate: new Date('2024-02-01'),
                endDate: new Date('2025-01-31'),
                memberMonths: 5310
              }
            },
            memberMonths: {
              currentTotal: 5310,
              renewalTotal: 5310,
              projectedMonthlyMembers: {
                current: 442.5,
                renewal: 442.5
              }
            },
            medicalClaims: {
              current: {
                totalClaims: 2065000,
                poolingLevel: 225000,
                pooledClaims: 185000,
                netClaims: 1880000,
                expPeriodMemberMonths: 5310,
                netPMPM: 354.05,
                adjustedNetPMPM: 354.05,
                projectedPMPM: 0
              },
              renewal: {
                totalClaims: 2065000,
                poolingLevel: 225000,
                pooledClaims: 185000,
                netClaims: 1880000,
                expPeriodMemberMonths: 5310,
                netPMPM: 354.05,
                adjustedNetPMPM: 362.14,
                projectedPMPM: 0
              }
            },
            pharmacyClaims: {
              current: {
                totalClaims: 530000,
                poolingLevel: 225000,
                pooledClaims: 0,
                netClaims: 530000,
                expPeriodMemberMonths: 5310,
                netPMPM: 99.81,
                adjustedNetPMPM: 99.81,
                projectedPMPM: 0
              },
              renewal: {
                totalClaims: 530000,
                poolingLevel: 225000,
                pooledClaims: 0,
                netClaims: 530000,
                expPeriodMemberMonths: 5310,
                netPMPM: 99.81,
                adjustedNetPMPM: 100.01,
                projectedPMPM: 0
              }
            },
            enrollment: {
              current: {
                single: { count: 188, rate: 525.00 },
                couple: { count: 141, rate: 1050.00 },
                spmd: { count: 47, rate: 945.00 },
                family: { count: 94, rate: 1312.50 },
                total: { count: 470, monthlyPremium: 246750, annualPremium: 2961000 }
              },
              renewal: {
                single: { count: 188, rate: 525.00 },
                couple: { count: 141, rate: 1050.00 },
                spmd: { count: 47, rate: 945.00 },
                family: { count: 94, rate: 1312.50 },
                total: { count: 470, monthlyPremium: 246750, annualPremium: 2961000 }
              }
            }
          },
          // Add 3 more plans with varying sizes and characteristics
          {
            planId: 'plan2',
            experiencePeriods: {
              current: {
                startDate: new Date('2023-02-01'),
                endDate: new Date('2024-01-31'),
                memberMonths: 3780
              },
              renewal: {
                startDate: new Date('2024-02-01'),
                endDate: new Date('2025-01-31'),
                memberMonths: 3780
              }
            },
            memberMonths: {
              currentTotal: 3780,
              renewalTotal: 3780,
              projectedMonthlyMembers: {
                current: 315,
                renewal: 315
              }
            },
            medicalClaims: {
              current: {
                totalClaims: 1375000,
                poolingLevel: 225000,
                pooledClaims: 65000,
                netClaims: 1310000,
                expPeriodMemberMonths: 3780,
                netPMPM: 346.56,
                adjustedNetPMPM: 346.56,
                projectedPMPM: 0
              },
              renewal: {
                totalClaims: 1375000,
                poolingLevel: 225000,
                pooledClaims: 65000,
                netClaims: 1310000,
                expPeriodMemberMonths: 3780,
                netPMPM: 346.56,
                adjustedNetPMPM: 354.75,
                projectedPMPM: 0
              }
            },
            pharmacyClaims: {
              current: {
                totalClaims: 350000,
                poolingLevel: 225000,
                pooledClaims: 0,
                netClaims: 350000,
                expPeriodMemberMonths: 3780,
                netPMPM: 92.59,
                adjustedNetPMPM: 92.59,
                projectedPMPM: 0
              },
              renewal: {
                totalClaims: 350000,
                poolingLevel: 225000,
                pooledClaims: 0,
                netClaims: 350000,
                expPeriodMemberMonths: 3780,
                netPMPM: 92.59,
                adjustedNetPMPM: 92.77,
                projectedPMPM: 0
              }
            },
            enrollment: {
              current: {
                single: { count: 134, rate: 510.00 },
                couple: { count: 100, rate: 1020.00 },
                spmd: { count: 34, rate: 918.00 },
                family: { count: 67, rate: 1275.00 },
                total: { count: 335, monthlyPremium: 170850, annualPremium: 2050200 }
              },
              renewal: {
                single: { count: 134, rate: 510.00 },
                couple: { count: 100, rate: 1020.00 },
                spmd: { count: 34, rate: 918.00 },
                family: { count: 67, rate: 1275.00 },
                total: { count: 335, monthlyPremium: 170850, annualPremium: 2050200 }
              }
            }
          }
        ],
        totalMemberMonths: 9090
      },
      carrierSpecificParameters: {
        plans: [
          {
            planId: 'plan1',
            planName: 'PPO High',
            poolingLevel: 225000,
            experienceWeights: {
              current: 0.33,
              renewal: 0.67
            },
            credibilityFactor: 1.00,
            ibnrFactors: {
              medical: {
                current: 1.0000,
                renewal: 1.0240
              },
              pharmacy: {
                current: 1.0000,
                renewal: 1.0020
              }
            },
            trendFactors: {
              medical: {
                annualCurrent: 1.1000,
                annualRenewal: 1.1003,
                monthsCurrent: 35.0,
                monthsRenewal: 23.0,
                compoundedCurrent: 1.3235,
                compoundedRenewal: 1.2010
              },
              pharmacy: {
                annualCurrent: 1.1073,
                annualRenewal: 1.1136,
                monthsCurrent: 35.0,
                monthsRenewal: 23.0,
                compoundedCurrent: 1.3462,
                compoundedRenewal: 1.2290
              }
            },
            adjustmentFactors: {
              ffsAge: {
                current: 1.0375,
                renewal: 1.0214
              },
              benefitAdjustment: 1.0000,
              underwriterAdjustment: 1.0000,
              pathwayToSavings: 0.9950
            },
            retentionComponents: {
              retentionPMPM: {
                current: 93.49,
                renewal: 145.11
              },
              ppoPremiumTax: {
                current: 6.48,
                renewal: 9.96
              },
              acaAdjustments: {
                current: 0.27,
                renewal: 0.41
              }
            },
            currentPremiumPMPM: 525.00,
            manualClaimsPMPM: {
              current: 367.92,
              renewal: 536.12
            }
          },
          {
            planId: 'plan2',
            planName: 'PPO Standard',
            poolingLevel: 225000,
            experienceWeights: {
              current: 0.33,
              renewal: 0.67
            },
            credibilityFactor: 1.00,
            ibnrFactors: {
              medical: {
                current: 1.0000,
                renewal: 1.0240
              },
              pharmacy: {
                current: 1.0000,
                renewal: 1.0020
              }
            },
            trendFactors: {
              medical: {
                annualCurrent: 1.1000,
                annualRenewal: 1.1003,
                monthsCurrent: 35.0,
                monthsRenewal: 23.0,
                compoundedCurrent: 1.3235,
                compoundedRenewal: 1.2010
              },
              pharmacy: {
                annualCurrent: 1.1073,
                annualRenewal: 1.1136,
                monthsCurrent: 35.0,
                monthsRenewal: 23.0,
                compoundedCurrent: 1.3462,
                compoundedRenewal: 1.2290
              }
            },
            adjustmentFactors: {
              ffsAge: {
                current: 1.0375,
                renewal: 1.0214
              },
              benefitAdjustment: 1.0000,
              underwriterAdjustment: 1.0000,
              pathwayToSavings: 0.9950
            },
            retentionComponents: {
              retentionPMPM: {
                current: 87.20,
                renewal: 135.34
              },
              ppoPremiumTax: {
                current: 6.04,
                renewal: 9.29
              },
              acaAdjustments: {
                current: 0.25,
                renewal: 0.38
              }
            },
            currentPremiumPMPM: 510.00,
            manualClaimsPMPM: {
              current: 343.05,
              renewal: 499.80
            }
          }
        ],
        compositeWeighting: {
          enrollmentBased: true,
          totalEnrollment: 805
        },
        globalSettings: {
          totalMemberMonths: 9090
        }
      }
    };
  };

  describe('Enhanced Multi-Plan Calculations', () => {
    test('should calculate individual plan results with all 30 calculation lines', async () => {
      const input = createTestInput();
      const result = await calculator.calculateRenewal(input, {
        calculationDate: new Date(),
        version: '2.0',
        requestId: 'test-enhanced'
      });

      expect(result.individualPlans).toHaveLength(2);
      
      // Verify each plan has comprehensive calculations
      result.individualPlans.forEach(plan => {
        expect(plan.calculations.length).toBeGreaterThan(25); // Should have most of the 30 lines
        
        // Check for key calculation lines
        const headerLines = plan.calculations.filter(c => ['1', '2', '2a'].includes(c.lineNumber));
        expect(headerLines.length).toBe(3);
        
        const medicalLines = plan.calculations.filter(c => c.section === 'medical');
        expect(medicalLines.length).toBeGreaterThan(5);
        
        const pharmacyLines = plan.calculations.filter(c => c.section === 'pharmacy');
        expect(pharmacyLines.length).toBeGreaterThan(5);
        
        const totalLines = plan.calculations.filter(c => c.section === 'total');
        expect(totalLines.length).toBeGreaterThan(15);
      });
    });

    test('should calculate enrollment-weighted composite correctly', async () => {
      const input = createTestInput();
      const result = await calculator.calculateRenewal(input, {
        calculationDate: new Date(),
        version: '2.0',
        requestId: 'test-composite'
      });

      expect(result.composite).toBeDefined();
      expect(result.composite.totalEnrollment).toBe(805);
      expect(result.composite.compositeRateAction).toBeDefined();
      expect(result.composite.enrollmentWeights).toBeDefined();
      
      // Verify enrollment weights sum to 100%
      const totalWeight = Object.values(result.composite.enrollmentWeights).reduce((sum, weight) => sum + weight, 0);
      expect(totalWeight).toBeCloseTo(1.0, 4);
    });

    test('should process medical trend calculations correctly', async () => {
      const input = createTestInput();
      const result = await calculator.calculateRenewal(input, {
        calculationDate: new Date(),
        version: '2.0',
        requestId: 'test-trend'
      });

      const plan1 = result.individualPlans[0];
      
      // Find medical trend calculation (Line 8)
      const medicalTrendStep = plan1.calculations.find(c => 
        c.lineNumber === '8' && c.description.includes('Medical Trend')
      );
      
      expect(medicalTrendStep).toBeDefined();
      expect(medicalTrendStep?.inputs.compoundedCurrent).toBeCloseTo(1.3235, 4);
      expect(medicalTrendStep?.inputs.compoundedRenewal).toBeCloseTo(1.2010, 4);
    });

    test('should apply credibility blending correctly', async () => {
      const input = createTestInput();
      const result = await calculator.calculateRenewal(input, {
        calculationDate: new Date(),
        version: '2.0',
        requestId: 'test-credibility'
      });

      const plan1 = result.individualPlans[0];
      
      // Find credibility adjustment (Line 22)
      const credibilityStep = plan1.calculations.find(c => 
        c.lineNumber === '22' && c.description.includes('Credibility Adjusted')
      );
      
      expect(credibilityStep).toBeDefined();
      expect(credibilityStep?.inputs.credibility).toBe(1.00);
      expect(credibilityStep?.result).toBeGreaterThan(0);
    });

    test('should calculate retention components correctly', async () => {
      const input = createTestInput();
      const result = await calculator.calculateRenewal(input, {
        calculationDate: new Date(),
        version: '2.0',
        requestId: 'test-retention'
      });

      const plan1 = result.individualPlans[0];
      
      // Find retention calculation (Line 23)
      const retentionStep = plan1.calculations.find(c => 
        c.lineNumber === '23' && c.description.includes('Retention')
      );
      
      expect(retentionStep).toBeDefined();
      expect(retentionStep?.inputs.currentRetention).toBe(93.49);
      expect(retentionStep?.inputs.renewalRetention).toBe(145.11);
    });

    test('should apply all adjustment factors in sequence', async () => {
      const input = createTestInput();
      const result = await calculator.calculateRenewal(input, {
        calculationDate: new Date(),
        version: '2.0',
        requestId: 'test-adjustments'
      });

      const plan1 = result.individualPlans[0];
      
      // Verify key adjustment factors are applied
      const ffsAgeStep = plan1.calculations.find(c => c.lineNumber === '11a');
      const benefitAdjStep = plan1.calculations.find(c => c.lineNumber === '14');
      const underwriterStep = plan1.calculations.find(c => c.lineNumber === '25');
      const p2sStep = plan1.calculations.find(c => c.lineNumber === '27');
      
      expect(ffsAgeStep?.inputs.currentAdjustment).toBe(1.0375);
      expect(benefitAdjStep?.result).toBe(1.0000);
      expect(underwriterStep?.result).toBe(1.0000);
      expect(p2sStep?.result).toBe(0.9950);
    });

    test('should calculate final rate action properly', async () => {
      const input = createTestInput();
      const result = await calculator.calculateRenewal(input, {
        calculationDate: new Date(),
        version: '2.0',
        requestId: 'test-rate-action'
      });

      const plan1 = result.individualPlans[0];
      
      // Find rate action calculation (Line 29)
      const rateActionStep = plan1.calculations.find(c => 
        c.lineNumber === '29' && c.description.includes('Rate Action')
      );
      
      expect(rateActionStep).toBeDefined();
      expect(rateActionStep?.inputs.requiredPremium).toBeGreaterThan(0);
      expect(rateActionStep?.inputs.currentPremium).toBe(525.00);
      expect(rateActionStep?.result).toBeDefined();
    });
  });

  describe('Data Quality Validation', () => {
    test('should validate multi-plan data completeness', async () => {
      const input = createTestInput();
      
      // Should not throw validation errors
      expect(async () => {
        await calculator.calculateRenewal(input, {
          calculationDate: new Date(),
          version: '2.0',
          requestId: 'test-validation'
        });
      }).not.toThrow();
    });

    test('should handle missing plan data gracefully', async () => {
      const input = createTestInput();
      // Remove one plan from multiPlanData but keep it in parameters
      input.multiPlanData.plans = input.multiPlanData.plans.slice(0, 1);
      
      expect(async () => {
        await calculator.calculateRenewal(input, {
          calculationDate: new Date(),
          version: '2.0',
          requestId: 'test-missing-data'
        });
      }).rejects.toThrow();
    });
  });
}); 